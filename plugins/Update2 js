import fetch from 'node-fetch'
import { createWriteStream, existsSync } from 'fs'
import { join } from 'path'
import { fileURLToPath } from 'url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = join(__filename, '..')

let confirmation = {}
let repository = 'watson-xd-2/WATSON-XD-BOT'
let branch = 'main'

async function handler(m, { text, conn }) {
    if (!text) return m.reply(`Please specify the file path.\nExample: .update1 package.json`)

    let url = `https://raw.githubusercontent.com/${repository}/${branch}/${text}`
    let res = await fetch(url)

    if (!res.ok) throw `File not found in repository.\nURL: ${url}`

    let filename = join(__dirname, '..', text)

    if (existsSync(filename)) {
        confirmation[m.sender] = {
            res,
            filename,
            text,
            timeout: setTimeout(() => {
                m.reply('Timed out. Update cancelled.')
                delete confirmation[m.sender]
            }, 60000)
        }
        throw 'File already exists. Do you want to overwrite it? (Y/n)'
    }

    let fileStream = createWriteStream(filename)
    res.body.pipe(fileStream)

    fileStream.on('finish', () => {
        m.reply('Update successful ✅')
        conn.sendFile(m.chat, filename, text, null, m)
    })
}

handler.all = async function (m, { conn }) {
    if (!(m.sender in confirmation)) return

    let { res, filename, text, timeout } = confirmation[m.sender]

    if (/^y(es|a)?$/i.test(m.text)) {
        let fileStream = createWriteStream(filename)
        res.body.pipe(fileStream)

        fileStream.on('finish', () => {
            m.reply('Overwrite completed ✅')
            conn.sendFile(m.chat, filename, text, null, m)
        })

        clearTimeout(timeout)
        delete confirmation[m.sender]
        return true

    } else if (/^no?$/i.test(m.text)) {
        m.reply('Cancelled ❌')
        clearTimeout(timeout)
        delete confirmation[m.sender]
        return true
    }
}

handler.help = ['update1']
handler.tags = ['owner']
handler.command = ['update1']
handler.rowner = true

export default handler
